<!DOCTYPE html>
<!-- 
 作者:KeJyun
 建立日期:2013-06-09
 最後修改日期:2013-08-11
 聯絡方式:kejyun@gmail.com
 -->
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Laravel 4 PHP Framework Documentation 繁體中文教學文件 : 佇列</title>
<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
<meta name="description" content="Laravel, 優雅的PHP網頁工匠框架(Framework) 開始享受開發上的樂趣吧!">
<meta name="keyword" content="Laravel,Documentation,教學,文件,繁體,中文,PHP,Framework,框架,優雅" />

<link media="all" type="text/css" rel="stylesheet" href="../../css/style.css">
<script src="../../js/modernizr-2.6.2.min.js"></script>

<style type="text/css">
.docs-menu ul li{
    margin-top: 10px;
}
.to-top{
    right: 515px;
}
body{
    font-family: "Helvetica Neue", Arial, 微軟正黑體, "Microsoft JhengHei", 新細明體, "Lucida Grande", "Lucida Sans Unicode", sans-serif;
}
</style>
</head>
<body>
<!-- Header -->
<header>
    <div class="container">
        <a href="http://laravel.com/" title="Laravel PHP Framework" class="logo" target="_blank">&nbsp;</a>
        <nav class="menu">
            <ul>
                <li>
                    <a href="http://laravel.com/" title="Welcome" target="_blank">Welcome</a>
                </li>
                <li>
                    <a href="http://laravel.com/docs" title="Documentation" target="_blank">Documentation</a>
                </li>
                <li class="active">
                    <a href="../../docs/introduction" title="中文文件">中文文件</a>
                </li>
                <li>
                    <a href="http://laravel.com/api" title="API" target="_blank">API</a>
                </li>
                <li>
                    <a href="https://github.com/laravel/laravel" title="Github" target="_blank">Github</a>
                </li>
                <li>
                    <a href="http://forums.laravel.io/" title="論壇" target="_blank">論壇</a>
                </li>
                <li>
                    <a href="http://twitter.com/laravelphp" title="Twitter" target="_blank">Twitter</a>
                </li>
            </ul>
        </nav>
        <a class="to-top">回到最上方</a>

    </div>
</header>

<!-- Header sectoin -->
<section class="docs-heading">
    <div class="container">
        <h2>文件</h2>
        <div class="sponsor">
            <span>贊助商 </span>
            <a href="http://www.cartalyst.com/" title="Cartalyst" target="_blank">
                <img src="../../img/cartalyst_small.png">
            </a>
        </div>
    </div>
</section>

<section class="docs-content">
    <div class="container">
    <nav class="docs-menu">
        <ul>
            <li>前言                <ul>
                    <li><a href="../../docs/introduction">介紹</a></li>
                    <li><a href="../../docs/quick">快速開始</a></li>
                    <li><a href="../../docs/contributing">貢獻</a></li>
                </ul>
            </li>
            <li>
                入門                <ul>
                    <li><a href="../../docs/installation">安裝</a></li>
                    <li><a href="../../docs/configuration">設定</a></li>
                    <li><a href="../../docs/lifecycle">生命週期</a></li>
                    <li><a href="../../docs/routing">路由</a></li>
                    <li><a href="../../docs/requests">請求及輸入<br />(Requests &amp; Input)</a></li>
                    <li><a href="../../docs/responses">視圖及回應<br />(Views &amp; Responses)</a></li>
                    <li><a href="../../docs/controllers">控制器(Controllers)</a></li>
                    <li><a href="../../docs/errors">錯誤及記錄</a></li>
                </ul>
            </li>

            <li>
                更多                <ul>
                <li><a href="../../docs/cache">快取</a></li>
                <li><a href="../../docs/events">事件</a></li>
                <li><a href="../../docs/facades">Facades</a></li>
                <li><a href="../../docs/html">表單及HTML</a></li>
                <li><a href="../../docs/helpers">Helpers 函式</a></li>
                <li><a href="../../docs/ioc">IoC容器</a></li>
                <li><a href="../../docs/localization">在地化</a></li>
                <li><a href="../../docs/mail">郵件</a></li>
                <li><a href="../../docs/packages">套件開發</a></li>
                <li><a href="../../docs/pagination">分頁</a></li>
                <li><a href="../../docs/queues">佇列</a></li>
                <li><a href="../../docs/security">安全性</a></li>
                <li><a href="../../docs/session">Session</a></li>
                <li><a href="../../docs/templates">樣板</a></li>
                <li><a href="../../docs/testing">單元測試</a></li>
                <li><a href="../../docs/validation">驗證</a></li>
                </ul>
            </li>
            <li>
                資料庫                <ul>
                    <li><a href="../../docs/database">基本用法</a></li>
                    <li><a href="../../docs/queries">Query產生器</a></li>
                    <li><a href="../../docs/eloquent">Eloquent ORM</a></li>
                    <li><a href="../../docs/schema">Schema產生器</a></li>
                    <li><a href="../../docs/migrations">Migrations &amp; Seeding</a></li>
                    <li><a href="../../docs/redis">Redis</a></li>
                </ul>
            </li>

            <li>
                Artisan介面指令                <ul>
                    <li><a href="../../docs/artisan">概要</a></li>
                    <li><a href="../../docs/commands">開發</a></li>
                </ul>
            </li>
        </ul>
    </nav>


    <article class="docs-body">
        <h1>佇列</h1>

<ul>
    <li>
        <a href="#configuration">設置</a>
    </li>
    <li>
        <a href="#basic-usage">基本使用</a>
    </li>
    <li>
        <a href="#queueing-closures">佇列閉合</a>
    </li>
    <li>
        <a href="#running-the-queue-listener">執行佇列傾聽器</a>
    </li>
    <li>
        <a href="#push-queues">推送佇列</a>
    </li>
</ul>

<p><a name="configuration"></a></p>

<h2>設置</h2>

<p>
    Laravel 對不同的佇列服務提供了統一的 API，佇列讓你可以延遲處理需要花費時間處理的任務，像是延遲寄送郵件，進而大幅加快應用程式的存取速度。
</p>

<p>
    佇列的設定檔放在 <code>app/config/queue.php</code>，在設定檔中可以找到 Laravel 支援的佇列服務連線設定，像是 <a href="http://kr.github.com/beanstalkd" target="_blank">Beanstalkd</a> 、 <a href="http://iron.io/" target="_blank">IronMQ</a> 、 <a href="http://aws.amazon.com/sqs" target="_blank">Amazon SQS</a> 及同步處理 (在本地端使用) 驅動。
</p>

<p>
    下列是佇列驅動所相依的套件:
</p>

<ul>
<li>Beanstalkd: <code>pda/pheanstalk</code></li>
<li>Amazon SQS: <code>aws/aws-sdk-php</code></li>
<li>IronMQ: <code>iron-io/iron_mq</code></li>
</ul>

<p><a name="basic-usage"></a></p>

<h2>基本使用</h2>

<p>
    使用 <code>Queue::push</code> 方法推送一個新的任務到佇列中:
</p>

<p><strong>推送任務到佇列</strong></p>

<pre><code>Queue::push('SendEmail', array('message' =&gt; $message));
</code></pre>

<p>
    傳送給 <code>push</code> 方法的第一個參數是用來處理這個佇列任務處理器的類別名稱，第二個參數是傳送給處理器處理的陣列資料，佇列任務處理器會被定義成像這樣:
</p>

<p><strong>定義一個佇列任務處理器</strong></p>

<pre><code>class SendEmail {

    public function fire($job, $data)
    {
        //
    }

}
</code></pre>

<p>
    注意，佇列任務處理器只需要 <code>fire</code> 方法，<code>fire</code> 方法會接收一個 <code>任務</code> 實例，就像推送 <code>處理資料</code> 到佇列一樣。
</p>

<p>
    你如果希望佇列任務處理器使用 <code>fire</code> 以外的方法去處理，你可以在推送資料給處理器時，去指定想要用來執行的方法:
</p>

<p><strong>指定自訂的處理器方法</strong></p>

<pre><code>Queue::push('SendEmail@send', array('message' =&gt; $message));
</code></pre>

<p>
    在你處理完佇列任務後，必須要將任務從佇列中刪除，可以在 <code>任務</code> 實例中使用 <code>delete</code> 方法來達到這個目的:
</p>

<p><strong>刪除被處理過的任務</strong></p>

<pre><code>public function fire($job, $data)
{
    // Process the job...

    $job-&gt;delete();
}
</code></pre>

<p>
    使用 <code>release</code> 方法可以將任務放回佇列:
</p>

<p><strong>將任務放回佇列</strong></p>

<pre><code>public function fire($job, $data)
{
    // Process the job...

    $job-&gt;release();
}
</code></pre>

<p>
    你也可以指定要延遲幾秒再將任務放回佇列:
</p>

<pre><code>$job-&gt;release(5);
</code></pre>

<p>
    如果在處理佇列任務時發生異常狀況，則任務將會自動放回佇列中，你可以用 <code>attempts</code> 方法去取得任務被嘗試處理的次數:
</p>

<p><strong>檢查任務被嘗試處理的次數</strong></p>

<pre><code>if ($job-&gt;attempts() &gt; 3)
{
    //
}
</code></pre>

<p>
    你也可以使用 <code>getJobId</code> 方法去取得任務的編號:
</p>

<p><strong>存取任務編號</strong></p>

<pre><code>$job-&gt;getJobId();
</code></pre>

<p><a name="queueing-closures"></a></p>

<h2>佇列閉合</h2>

<p>
    你也可以推送閉合凾式到佇列中，這是相當方便且快速、簡單的處理佇列任務:
</p>

<p><strong>推送閉合凾式到佇列</strong></p>

<pre><code>Queue::push(function($job) use ($id)
{
    Account::delete($id);

    $job-&gt;delete();
});
</code></pre>

<blockquote>
  <p><strong>注意:</strong> 當推送閉合函式到佇列中，不應該使用 <code>__DIR__</code> 及 <code>__FILE__</code> 常數</p>
</blockquote>

<p>
    當你使用 Iron.io <a href="#push-queues">推送佇列</a> ，你應該做額外的閉合函式佇列預防措施，在接收佇列訊息時應該要檢查請求的標記 (token) 是否真的是來自 Iron.io ，舉例來說，你推送到佇列訊息的結尾應該要長得像這樣: <code>https://yourapp.com/queue/receive?token=SecretToken</code>，你可以在安排處理佇列時檢查標記是否合法。
</p>

<p><a name="running-the-queue-listener"></a></p>

<h2>執行佇列傾聽器</h2>

<p>
    Laravel 包含了 Artisan 佇列任務的指令，可以去執行新的推送到佇列的任務，你可以使用 <code>queue:listen</code> 指令去執行這個功能:
</p>

<p><strong>開啟佇列傾聽器</strong></p>

<pre><code>php artisan queue:listen
</code></pre>

<p>
    你可以指定佇列傾聽器要使用哪一個連結:
</p>

<pre><code>php artisan queue:listen connection
</code></pre>

<p>
    注意，一但佇列傾聽器任務啟動，除非手動停止，否則將會持續的做佇列傾聽的動作，你可以使用 <a href="http://supervisord.org/" target="_blank">Supervisor</a> 監看工具去確認佇列傾聽器的執行狀況。
</p>

<p>
    你也可以設定每個佇列傾聽器任務的執行時間 (秒):
</p>

<p><strong>指定佇列傾聽器任務的執行時間</strong></p>

<pre><code>php artisan queue:listen --timeout=60
</code></pre>

<p>
    使用 <code>queue:work</code> 指令去執行在佇列的第一個任務:
</p>

<p><strong>處理在佇列的第一個任務</strong></p>

<pre><code>php artisan queue:work
</code></pre>

<p><a name="push-queues"></a></p>

<h2>推送佇列</h2>

<p>
    推送佇列讓你可以在沒有執行任何自動執行或背景執行的傾聽器時，使用 Laravel 的強大的佇列工具，現在推送佇列只支援 <a href="http://iron.io/" target="_blank">Iron.io</a> 驅動，在開始使用佇列之前，必須先建立 Iron.io 帳號，並把帳號相關驗證資訊設定寫到 <code>app/config/queue.php</code> 設定檔中。
</p>

<p>
    接下來你可以在 Artisan 指令使用 <code>queue:subscribe</code> 指令去註冊一個接收佇列任務的應用程式網址:
</p>

<p><strong>註冊推送佇列訂閱器</strong></p>

<pre><code>php artisan queue:subscribe queue_name http://foo.com/queue/receive
</code></pre>

<p>
    當你現在去登入 Iron 後台，你會看到一個新的推送佇列及訂閱的網址，你可以訂閱任何想要推送到佇列的網址，接下來，建立一個路由到 <code>queue/receive</code>，並回傳 <code>Queue::marshal</code> 方法的回應:
</p>

<pre><code>Route::post('queue/receive', function()
{
    return Queue::marshal();
});
</code></pre>

<p>
    <code>marshal</code> 方法會自動執行正確的任務處理類別，若想要將任務推送到佇列，只要用原本的相同的 <code>Queue::push</code> 方法即可。
</p>
        <h1>討論</h1>
        <div id="disqus_thread"></div>
    </article>
    <div class="clearfix"></div>
    </div>


    
</section>



<footer>
    <div class="container">
        <a href="http://laravel.com/" title="Laravel PHP Framework" class="logo" target="_blank">
            <img src="http://laravel.com/img/footer_logo.png" alt="Laravel PHP Framework">
        </a>
        <nav class="menu">
            <ul>
                <li>
                    <a href="http://laravel.com/" title="Welcome" target="_blank">Welcome</a>
                </li>
                <li>
                    <a href="http://laravel.com/docs" title="Documentation" target="_blank">Documentation</a>
                </li>
                <li class="active">
                    <a href="../../docs/introduction" title="中文文件">中文文件</a>
                </li>
                <li>
                    <a href="http://laravel.com/api" title="API" target="_blank">API</a>
                </li>
                <li>
                    <a href="https://github.com/laravel/laravel" title="Github" target="_blank">Github</a>
                </li>
                <li>
                    <a href="http://forums.laravel.io/" title="論壇" target="_blank">論壇</a>
                </li>
                <li>
                    <a href="http://twitter.com/laravelphp" title="Twitter" target="_blank">Twitter</a>
                </li>
            </ul>
        </nav>
        <p class="copyright">Copyright &copy; 2013 Taylor Otwell. 網站由 <a href="http://casserolelabs.com/" title="Casserole Labs" target="_blank">Casserole Labs</a> 及 <a href="http://daylerees.com" title="Dayle Rees">Dayle Rees</a> 設計，中文翻譯 <a href="http://blog.kejyun.com" target="_blank">KeJyun</a> 及 <a href="http://blog.liaosankai.com" target="_blank">SANKAI</a> </p>
    </div>
</footer>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://laravel.com/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="../../js/plugins.js"></script>
<script src="../../js/main.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-31063691-6', 'kejyun.github.io');
  ga('send', 'pageview');
</script>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'laraveltw'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>